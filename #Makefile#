# Define compiler for building JSDNTrace and JPcap
JFLAGS = -g -cp
JC = javac

# Define C compiler for building libpcap
CC = g++

# Define UNIX Tools
AWK = awk
FIND = /bin/find
MKDIR = mkdir -p
RM = rm -rf
SHELL = /bin/bash

# The directory where compiled java source will be placed
CLASS_DIR = bin/

.SUFFIXES: .java .class

# Define where the floodlight logging objects are.
SLF4J = /home/aaron/floodlight/lib/slf4j-api-1.6.4.jar

# Define where the floodlight types are
# TODO: How to I properly point to a JAR?
FLOODLIGHT_TYPES = /home/aaron/floodlight/lib/openflowj-0.9.0-SNAPSHOT.jar

JPCAP = jpcap/usr/java/packages/lib/ext/jpcap.jar

JARS = $(SLF4J):$(FLOODLIGHT_TYPES):$(JPCAP)

OUTPUT_JAR = TraceClient.jar

JAR = jar
JARFlags = -cvf

MANIFEST_TEMPLATE = src/manifests/default.mf
TMP_JAR_DIR       = $(call make-temp-dir)
TMP_MANIFEST      = $(TMP_JAR_DIR)/manifest.m
VERSION_NUMBER = 1.0

FLOODLIGHT_PACKET = $(shell find ~/floodlight/src/main/java/net/floodlightcontroller/packet -type f -name '*.java')

java_source = \
	$(FLOODLIGHT_PACKET) \
	src/traceapp/core/Hop.java \
	src/traceapp/core/TracePacket.java \
	src/traceapp/core/JpcapTracePacket.java \
	src/traceapp/core/TraceClient.java

.PHONY: classpath
classpath:
        @echo "export CLASSPATH='$(CLASSPATH)'"

# Compile all the necessary java source into class files
.java.class:
	$(JC) $(JFLAGS) $(JARS) $(java_source) -d $(CLASS_DIR)

.PHONY: $(OUTPUT_JAR)
$(OUTPUT_JAR):
	$(JAR) cfm $@ $(MANIFEST_TEMPLATE) $(CLASS_DIR)

# #$(JAR) cfm $@ $(MANIFEST_TEMPLATE) 

all: .java.class .PHONY

default: all

clean: 
	rm bin/traceapp/core/Hop.class
	rm bin/traceapp/core/TracePacket.class
	rm bin/traceapp/core/JpcapTracePacket.class
	rm bin/traceapp/core/TraceClient.class
	rm -r bin/net
	rm TraceClient.jar

## Miscellaneous Functions Defined Below ##

# #(call make-temp-dir, root-opt)
define make-temp-dir
  mktemp -t $(if $1,$1,make).XXXXXXXXXX
endef

# $(call add-manifest, jar, jar-name, manifest-file-opt)
define add-manifest
  $(RM) $(dir $(TMP_MANIFEST))
  $(MKDIR) $(dir $(TMP_MANIFEST))
  m4 --define=NAME="$(notdir $2)"                       \
     --define=IMPL_VERSION=$(VERSION_NUMBER)            \
     --define=SPEC_VERSION=$(VERSION_NUMBER)            \
     $(if $3,$3,$(MANIFEST_TEMPLATE))                   \
     > $(TMP_MANIFEST)
  $(JAR) -ufm $1 $(TMP_MANIFEST)
  $(RM) $(dir $(TMP_MANIFEST))
endef

# $(call make-jar,jar-variable-prefix)
define make-jar
  .PHONY: $1 $$($1_name)
  $1: $($1_name)
  $$($1_name):
        cd $(OUTPUT_DIR); \
        $(JAR) $(JARFLAGS) $$(notdir $$@) $$($1_packages)
        $$(call add-manifest, $$@, $$($1_name), $$($1_manifest))
endef

# $(call build-classpath, variable-list)
define build-classpath
$(strip                                          \
  $(patsubst %:,%,                               \
    $(subst : ,:,                                \
      $(strip                                    \
        $(foreach c,$1,$(call get-file,$c):)))))
endef

# $(call get-file, variable-name)
define get-file
  $(strip                                       \
    $($1)                                       \
    $(if $(call file-exists-eval,$1),,          \
      $(warning The file referenced by variable \
                '$1' ($($1)) cannot be found)))
endef

# $(call file-exists-eval, variable-name)
define file-exists-eval
  $(strip                                        \
    $(if $($1),,$(warning '$1' has no value))    \
    $(wildcard $($1)))
endef
